name: Issue Comment

on:
  issues:
    types: [opened]
  
    # Manual trigger
  workflow_dispatch:
    inputs:
      issueNumber:
        description: 'The number of the issue to analyze manually'
        required: true
        type: string

jobs:
  check-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    # Define an environment variable that works for both triggers
    env:
      # If triggered by 'issues', it uses github.event.issue.number.
      # If triggered by 'workflow_dispatch', it uses the number you provided in the form.
      ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issueNumber }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject Custom Config (For Proxy Support)
        run: |
          mkdir -p ~/.config/opencode
          # Build and write opencode.json with secrets
          CONFIG='{
            "$schema": "https://opencode.ai/config.json",
            "provider": {
              "llm-proxy": {
                "npm": "@ai-sdk/openai-compatible",
                "name": "Proxy",
                "options": {
                  "baseURL": "${{ secrets.PROXY_BASE_URL }}",
                  "apiKey": "${{ secrets.PROXY_API_KEY }}",
                  "headers": {
                    "User-Agent": "OpenCode/1.0",
                    "X-Custom-Header": "your-value"
                  }
                },
                "models": {
                  "${{ secrets.OPENCODE_MODEL }}": {
                    "name": "Custom Model"
                  }
                }
              }
            },
            "autoupdate": true
          }'
          echo "$CONFIG" > ~/.config/opencode/opencode.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.12-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.12

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Install opencode
        run: curl -fsSL https://opencode.ai/install | bash
      
      # FIX: Create the directory that opencode expects
      - name: Ensure opencode directory exists
        run: mkdir -p /home/runner/.local/share/opencode/project

      # NEW STEP: Fetch issue details so they are available for both triggers
      - name: Fetch Issue Details
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          issue_data=$(gh issue view ${{ env.ISSUE_NUMBER }} --json title,body)
          echo "ISSUE_TITLE=$(echo "$issue_data" | jq -r .title)" >> $GITHUB_ENV
          echo "ISSUE_BODY=$(echo "$issue_data" | jq -r .body)" >> $GITHUB_ENV
          
      - name: Analyze issue and suggest resolution
        env:
          OPENCODE_API_KEY: ${{ secrets.PROXY_API_KEY }}
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          OPENCODE_PERMISSION: |
            {
              "bash": {
                "gh*": "allow",
                "git*": "allow"
              },
              "webfetch": "deny"
            }
        run: |
          # Use a heredoc (<<EOF) to pass the prompt safely via stdin.
          # The "-" tells the opencode command to read the prompt from stdin.
          opencode run --share -m llm-proxy/${{ secrets.OPENCODE_MODEL }} - <<EOF
          You are an expert software engineer specializing in bug detection and resolution. Your goal is to provide a comprehensive initial analysis of this new issue to help the maintainers.

          A new issue has been created: '${{ env.ISSUE_TITLE }}'

          <issue-number>
          ${{ env.ISSUE_NUMBER }}
          </issue-number>

          <issue-description>
          ${{ env.ISSUE_BODY }}
          </issue-description>

          Investigate this issue thoroughly by following these steps:
          1.  **Understand the Problem:** Scrutinize the issue title and description to fully grasp the reported problem.
          2.  **Explore the Codebase:** Navigate the repository to find the most relevant files, configurations, or recent commits related to the issue. Utilize `git` and `gh` commands for this exploration.
          3.  **Identify the Root Cause:** Based on your code exploration, determine the most likely root cause of the issue.
          4.  **Validate the Issue:** Assess if the issue is valid, a duplicate, or if it requires more information from the user.
          5.  **Propose a Solution:** Outline a clear and actionable plan for remediation. This should include specific files to modify and the proposed changes.

          After your investigation, summarize your findings in a single, well-formatted comment on the issue using `gh issue comment`. The comment should have the following structure:

          **Summary:** A one-sentence overview of your findings.
          **Issue Validation:** State whether the issue is `Confirmed`, `Partially Confirmed`, `Needs More Info`, or a `Duplicate`.
          **Root Cause Analysis:** Explain the suspected root cause with supporting evidence (e.g., file paths, function names).
          **Proposed Next Steps:** Provide concrete steps or code snippets for the maintainers to resolve the issue.
          **Missing Information (if any):** If the issue cannot be fully validated, clearly state what information is needed from the issue filer.

          At the end of your comment, add the following note: '_This analysis was generated by an AI assistant._'
          EOF